#first import the debian cd's into the machine

apt-cdrom add

apt-get install aptitude
aptitude install bind9 bind9-utils

cd /etc/bind
vim named.conf
	# comment out
	# include "/etc/bind/named.conf.defaults";

mkdir internals
mkdir externals
chmod 777 externals/
chmod 777 internals/
chown bind:bind externals/
chown bind:bind internals/

vim named.conf.local
		acl internals {
			192.168.1.0/24;
			192.168.2.0/24;
			10.1.1.0/24;
		};
	
		acl externals {
			210.103.5.0/26;
			210.103.5.64/26;
			210.103.5.128/25;
		};
	
		view "internal" {
			match-clients { internals; };
			zone "wsc2022.kr" IN {
				type master;
				file "/etc/bind/internals/wsc2022.kr.lan";
				allow-transfer { none; };
				
			};
		
			zone "1.168.192.in-addr.arpa" IN {
				type master;
				file "/etc/bind/internals/1.168.192.db";
				allow-transfer { none; };
				
			};
			
			zone "2.168.192.in-addr.arpa" IN {
				type master;
				file "/etc/bind/internals/2.168.192.db";
				allow-transfer { none; };
			};
			
			zone "1.1.10.in-addr.arpa" IN {
				type master;
				file "/etc/bind/internals/1.10.10.db";
				allow-transfer { none; };
			};

			zone "." IN {
				type hint;
				file "/etc/bind/root.hints";
			};
		};
	
		view "external" {
			match-clients { externals; };
			zone "wsc2022.kr" IN {
				type master;
				file "/etc/bind/externals/wsc2022.kr.lan";
			};
	
			zone "5.103.210.in-addr.arpa" IN {
				type master;
				file "/etc/bind/externals/5.103.210.db";
			};
		};

cp db.127 internals/wsc2022.kr.lan
cd internals/
nano wsc2022.kr.lan
		$TTL 86400
		@   IN  SOA     dmzsrv.wsc2022.kr. root.dmzsrv.wsc2022.kr. (
				         1      ;Serial
		        604800      ;Refresh
		        86400       ;Retry
		        2419200     ;Expire
		        86400 )     ;Negative Cache TTL
		;
	@    IN    NS    dmzsrv.wsc2022.kr.
	@    IN    A     192.168.2.1
	@	   IN    MX 10 dmzsrv.wsc2022.kr.
	@		 IN    MX 20 fr-srv.wsc2024.fr.
	www  IN    CNAME dmzsrv
	monitor IN CNAME dmzsrv 
	dmzsrv IN  A     192.168.2.1
	fw   IN    A     192.168.2.254
			 IN    A     192.168.1.254
	     IN    A     10.1.1.1
	intsrv IN  A     192.168.1.1
	KR-EDGE IN A     10.1.1.2

nano 1.1.10.db
		$TTL 86400
		@   IN  SOA     dmzsrv.wsc2022.kr. root.dmzsrv.wsc2022.kr. (
				         1      ;Serial
		        604800      ;Refresh
		        86400       ;Retry
		        2419200     ;Expire
		        86400 )     ;Negative Cache TTL
		;
	@    IN    NS    dmzsrv.wsc2022.kr.
	2    IN    PTR   KR-EDGE.wsc2022.kr.
	1    IN    PTR   fw.wsc2022.kr.


nano 1.168.192.db
		$TTL 86400
		@   IN  SOA     dmzsrv.wsc2022.kr. root.dmz.srv.wsc2022.kr. (
				         1      ;Serial
		        604800      ;Refresh
		        86400       ;Retry
		        2419200     ;Expire
		        86400 )     ;Negative Cache TTL
		;
	@    IN    NS    dmzsrv.wsc2022.kr.
	1    IN    PTR   intsrv.wsc2022.kr.
	254  IN    PTR   fw.wsc2022.kr.


nano 2.168.192.db
		$TTL 86400
		@   IN  SOA     dmzsrv.wsc2022.kr. root.dmz.srv.wsc2022.kr. (
				         1      ;Serial
		        604800      ;Refresh
		        86400       ;Retry
		        2419200     ;Expire
		        86400 )     ;Negative Cache TTL
		;
	@    IN    NS    dmzsrv.wsc2022.kr.
	1    IN    PTR   dmzsrv.wsc2022.kr.
	254  IN    PTR   fw.wsc2022.kr.

cd ../
nano named.conf.options

	acl internal-network{
		192.168.2.0/24;
		192.168.1.0/24;
		10.1.1.0/30;
	}
	
	acl external-network{
		210.103.5.0/26;
		210.103.5.64/26;
		210.103.5.128/25;
	}
	
	options{
	 
	#add these
	forwarders {
		210.103.5.65;
		210.103.5.129;
	};
	
	allow-query { localhost; internal-network; external-network; };
	allow-transfer { localhost; };
	allow-recursion { localhost; internal-network; external-network; };
	recursion yes;
	dnssec-validation no;

cp internals/wsc2022.kr.lan externals/
cp internals/2.168.192.db externals/5.103.210.db
cd externals/
nano wsc2022.kr.lan
		$TTL 86400
		@   IN  SOA     dmzsrv.wsc2022.kr. root.dmz.srv.wsc2022.kr. (
				         1      ;Serial
		        604800      ;Refresh
		        86400       ;Retry
		        2419200     ;Expire
		        86400 )     ;Negative Cache TTL
		;
	@    IN    NS    dmzsrv.wsc2022.kr.
	@    IN    A     210.103.5.1
	@	   IN    MX 10 dmzsrv.wsc2022.kr.
	@		 IN    MX 20 fr-srv.wsc2024.fr.
	www  IN    CNAME dmzsrv
	monitor IN CNAME dmzsrv
	dmzsrv IN  A     210.103.5.1
	KR-EDGE IN CNAME dmzsrv 


nano 5.103.210.db
		$TTL 86400
		@   IN  SOA     dmzsrv.wsc2022.kr. root.dmzsrv.wsc2022.kr. (
				         1      ;Serial
		        604800      ;Refresh
		        86400       ;Retry
		        2419200     ;Expire
		        86400 )     ;Negative Cache TTL
		;
	@    IN    NS    dmzsrv.wsc2022.kr.
	1    IN    PTR   dmzsrv.wsc2022.kr. # KR-EDGE.wsc

cp /usr/share/dns/root.hints root.hints

nano root.hints
	#remove all dns hints
	#add these
	.         3600000     NS     INET.
	INET.     3600000     A      210.103.5.129

cat root.hints >> /usr/share/dns/root.hints

systemctl restart bind9
systemctl status bind9

# if got problem, remove the cache 
rndc flush
rndc reload
